name: Building Java 17 and verifying with Maven, Clamscan and Trivy

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      tag:
        type: string
        default: 'latest'

jobs:
  Buildando-jar:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Buildando com Maven
      run: |
        echo "Iniciando build..."
        mvn -B package -DskipTests --file pom.xml
    - name: Subindo jar
      uses: actions/upload-artifact@v4
      with:
        name: target-folder-${{ inputs.image_name }}-${{ inputs.tag }}
        path: ./target
        retention-days: 1

  Clamscan:
    runs-on: ubuntu-latest
    needs: Buildando-jar
    steps:
    - name: Download target folder from build
      uses: actions/download-artifact@v4
      with:
        pattern: target-folder-${{ inputs.image_name }}*
        path: ./target
    - name: Instalando clamav para verificação do .jar
      run: |
        sudo apt-get update
        sudo apt-get install -y clamav clamav-daemon
        sudo systemctl stop clamav-freshclam.service || true
        sudo freshclam --quiet
    - name: Executando verificação ClamAV
      run: |
        echo "Verificando arquivos em target/"
        ls -la target/
        echo "Executando ClamAV scan..."
        clamscan --infected --recursive ./target/ || true

  trivy-scan:
    runs-on: ubuntu-latest
    needs: Clamscan
    container:
      image: aquasec/trivy:latest
    steps:
      - name: Download target folder from build job
        uses: actions/download-artifact@v4
        with:
          pattern: target-folder-${{ inputs.image_name }}*
          path: ./target
      - name: Listando arquivos para scan
        run: ls -la ./target/
      - name: Scan JAR with Trivy
        run: |
          JAR_FILE=$(find ./target -name "*.jar" | head -1)
          if [ -n "$JAR_FILE" ]; then
            echo "Scanning $JAR_FILE"
            trivy fs "$JAR_FILE" --severity CRITICAL,HIGH --exit-code 1 --no-progress
          else
            echo "No JAR file found in target/"
            exit 1
          fi
